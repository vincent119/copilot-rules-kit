---
description: 'YAML / IaC (Pulumi, Kubernetes, CloudFormation) 編輯與產生規範'
applyTo: '**/*.yaml,**/*.yml'
---

本檔延伸自 `.github/copilot-common.md` 與 `.github/copilot-vocabulary.yaml`，僅針對 YAML 特有規範補充。

# YAML / IaC 指南（for Copilot & VS Code Agent）

本文件定義 YAML 類檔案（Pulumi, Kubernetes, CloudFormation, Helmfile, GitHub Actions 等）的產生與修改規範。
所有生成結果須 **可被解析**、**可直接部署**、**不破壞結構**。

---

## 通用原則

- **保持縮排一致**（預設 1 Tab 等於 2 空白）。
- 僅使用合法 YAML 語法，禁止多餘空白、特殊控制符。
- **保留 key 順序**，不可自動重排（特別是 Pulumi / Helmfile）。
- 保留註解與註解順序。
- 若內容含 `$`, `${}`, `!Ref`, `!Sub` 等語法，視為模板標記，不可轉義或刪除。
- 若編輯 CloudFormation / Pulumi / Helm YAML：
  - 保留所有 `!` 開頭的 intrinsic functions。
  - 不自動展開或重新排序 tags。

---

## 檔案操作規則

- 若為現有檔案：
  - 僅修改指定 key/value。
  - 不可刪除未知欄位。
- 若需新增段落：
  - 按現有結構與層級對齊。
- 若為自動產生：
  - 新檔案需有文件頭註解：
    ```yaml
    # Generated by AI (review before commit)
    ```

---

## 結構與風格

- key 名稱採 **snake_case**（如 `service_account_name`）。
- 保持巢狀層級 ≤ 4，必要時拆成多檔。
- 使用 `- name:` 格式，而非 inline array。
- 字串預設使用雙引號 `"..."`。
- 僅在必要時加引號：
  - 含空白、冒號、布林混淆值時。
- 避免自動折行長字串（除非明確指定）。

---

## Pulumi / IaC 特例

- Pulumi YAML:
  - 不可新增未宣告的 property。
  - 保留 `options: providers:` 區塊順序。
  - 若新增資源：
    - `type`、`name`、`properties`、`options` 須齊全。
- CloudFormation:
  - 保留 `!Ref`, `!Sub`, `!GetAtt`, `!FindInMap` 等語法。
  - 禁止展開 pseudo parameters。
- Kubernetes Manifests:
  - `apiVersion`, `kind`, `metadata`, `spec` 必須位於頂層。
  - 不移動 annotation 與 label。

---

## YAML Schema 與自動補全

- 支援以下結構：
  - `k8s-*.yaml`、`manifests/**/*.yaml` → Kubernetes Schema
  - `Pulumi.yaml` → Pulumi Schema
  - `.github/workflows/*.yaml` → GitHub Actions Schema
  - `.gitlab-ci.yml` → GitLab CI Schema
- 遵守編輯器設定：
  ```json
  "yaml.format.singleQuote": false,
  "yaml.format.bracketSpacing": true,
  "yaml.format.lineWidth": 0
  ```

---

## 詞彙與術語（外部參照）

本檔不再內嵌詞彙表；統一參照 `.github/copilot-vocabulary.yaml`。請遵循其中 forbidden/preferred/mapping 規則。如與既有程式碼命名衝突，應在變更說明中說明並提供過渡策略。

## Copilot / Agent 產生行為

- **優先保持原有縮排結構**。
- 插入內容時：
  - 若 key 存在 → 更新 value。
  - 若 key 不存在 → 依區塊邏輯插入。
- 產出 YAML 時：
  - 不自動加 `---` 多文件分隔，除非有多文件。
  - 禁止將多檔內容合併。
- 若為環境設定（dev/stg/prod）：
  - 僅覆蓋對應環境 key，不修改全域設定。

---

## Review Checklist

- [ ] 縮排與原始一致（2 spaces）
- [ ] 無多餘 tab 或 NBSP
- [ ] 所有 intrinsic function 保留
- [ ] Pulumi / CFN key 順序正確
- [ ] 不刪除未知欄位
- [ ] 可通過 `yamllint` 驗證
- [ ] YAML 可被目標工具解析

---

 **建議放置路徑：**
```
.github/
 ├─ copilot-instructions.md   ← 全域設定
 ├─ go.instructions.md        ← Go 專用
 └─ yaml.instructions.md      ← YAML / IaC 專用（此檔案）
```
